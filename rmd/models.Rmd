# Description of models

In the following section, we will motivate and define mathematically four Generalised Linear Models (GLMs) implemented in Stan and using BRMS in two cases.

```{r}
# install libraries
library(survival)
library(tidyverse)
library(rstan)
library(brms)
library(bayesplot)
library(loo)
library(reshape2)
library(ggplot2)
library(splines2)
# set number of cores
options(mc.cores = parallel::detectCores())

# read lung cancer data from `survival` library
data("cancer", package = "survival")
# build dataset from only those non-censored data points
uncensored_data <- cancer %>%
  filter(status == 2) %>%
  drop_na()
# identify covariate labels and build design matrix
cov_labels <- uncensored_data %>%
  dplyr::select(-status,-time,-inst) %>%
  colnames()
# build design matrix
X <- as.matrix(uncensored_data[cov_labels])
# print(dim(X))
# [1] 120   7
y <- uncensored_data$time
# build data list for Stan model
weibull_data = list(
  y = y, X = X, N = length(y), M = ncol(X)
)
```

## Weibull without censored data

Let $y \sim \text{Weibull}(\alpha, \sigma)$, so that
$$
\text{Weibull}(y|\alpha,\sigma) =
\frac{\alpha}{\sigma} \, \left( \frac{y}{\sigma} \right)^{\alpha - 1}
\, \exp \! \left( \! - \left( \frac{y}{\sigma} \right)^{\alpha}
\right),
$$
for $y \in [0,\infty), \alpha \in \mathbb{R}^+,$ and $\sigma \in \mathbb{R}^+$. 

### Motivating the distribution

The Weibull distribution is often used as a more flexible and complex alternative to the semi-parametric proportional hazard Cox model for modelling time to failure events, since the hazard rate is not taken to be constant with time.

### The Weibull distribution as a member of the exponential family

Now take $\alpha$ fixed and finite, then it can be shown that this distribution belongs to the exponential family since we can write it's probability density function
$$
\text{Weibull}(y|\sigma) ={\alpha y^{\alpha -1}}\exp(-y^{\alpha}\sigma^{-\alpha}-\alpha\log\sigma),
$$
with
\begin{align*}
b(y)&={\alpha y^{\alpha -1}} \\
\eta&=\sigma^{-\alpha}\\
T(y)&=-y^{\alpha} \\
a(\eta)&=\alpha\log\sigma.
\end{align*}

### Defining the link function

Looking at our sufficient statistic $\eta=\sigma^{-\alpha}$, it can be shown that
$$
\sigma=\exp{({\frac{\log\eta}{-\alpha}})}
$$
where we construct $\eta = \exp(\boldsymbol X\beta)$ so that $\eta$ is strictly positive. Thus we choose a log link function for our GLM such that
$$
\sigma = \exp(-\frac{\boldsymbol X\beta}{\alpha}).
$$

### Priors

In our Stan model, we will enforce two priors over each of the regressors in the linear model, and the shape parameter of our resulting Weibull distribution. Mathematically, where we have $N$ data points and $M$ covariates, the model is defined as
\begin{align*}
y_i &\sim \text{Weibull}(\sigma, \alpha)\,,\quad i = 1,\dots,N,\\
\alpha &\sim \text{Half-Cauchy}(5),\\
\sigma &= \exp\left ( -\frac{\boldsymbol X \beta}{\alpha}\right ),\\
\beta_k \sim& N(0, 10)\,,\quad k=1,\dots,M.\\
\end{align*}
The choice of a Half-Cauchy prior is motivated in @taumain, so that inferences are sensitive to the choice of weakly-informative priors. Note that this is a specific case of the of the conditionally-conjugate folded-noncentral-t family of prior distributions. In this pooled model, we model these parameters the same across all institutions. Intuitively, this means that we expect the hazard to be equivalent regardless of which institution a patient is in. This is seen visually below in Figure \ref{}.

### Implemented in Stan

Below, we fit the model in Stan and output the Stan code for the reader.

```{r weibull, warning=FALSE, message=FALSE, comment=FALSE}
# compile and run seperate model
wm <- rstan::stan_model(file = "../stan/weibull_survival.stan")
# print out Stan code
print(wm)
# learn the model parameters
weibull_model <- rstan::sampling(
  wm,
  iter = 10000,
  data = weibull_data
)
```

## Weibull with censored data

The density function for Weibull distributed survival times is given as

$$
{p(t_{i}|\alpha,\lambda_{i}) = \alpha t_{i}^{\alpha-1}\exp{(\lambda_{i}-\exp{\lambda_{i}}t_{i}^{\alpha})}},
$$

and can be rewritten as

$$
{p(t_{i}|\alpha,\gamma_{i}) = \exp{\bigg(-\bigg(\frac{t_{i}}{\gamma_{i}}\bigg)^{\alpha}\bigg)}\frac{\alpha}{\gamma_{i}}\bigg(\frac{t_{i}}{\gamma_{i}}\bigg)^{\alpha-1}},
$$
where $\alpha$ is the shape parameter, and $\gamma$ the scale. We move on to define a new variable $\lambda$ is created, defined in relation to $\gamma$ as

$$
{\lambda=-\alpha \log{\gamma}}.
$$

The survival function, showing the probability that the death will be after a certain time t, is then

$$
{S(t_{i}|\alpha,\lambda_{i})=\exp(-\exp(\lambda_{i})t_{i}^{\alpha})}.
$$

The likelihood of $\alpha$ and $\lambda$ follows the equation below, with $v_{i}$ an indicator showing 0 if the data are censored and 1 if not,

$$
{L(\alpha,\lambda|t)=\prod\limits_{i = 1}^n p(t_{i}|\alpha,\lambda_{i})^{v_{i}} S(t_{i}|\alpha,\lambda_{i})^{1-v_{i}}}=
\prod\limits_{i = 1}^n (\alpha t_{i}^{\alpha-1}exp(\lambda_{i}))^{v_{i}}(exp(-exp(\lambda_{i})t_{i}^{\alpha})).
$$

If $\lambda=X\beta$, than log-likelihood function can be expressed as,

$$
l(\alpha,\beta|t,x)=\sum\limits_{i = 1}^nv_{i}(\log(\alpha)+(\alpha-1)log(t_{i})+X_{i}\beta)-\exp(X_{i}\beta)t_{i}^{\alpha}.
$$
If the data are censored, log-likelihood consists only of the logarithm of the survival function. In Stan this can be expressed with `weibull_lccdf()` function, corresponding to the log of the Weibull complementary cumulative distribution function of $y$ given shape $\alpha$ and scale $\sigma$, and it is exactly the logarithm of survival function. For clarity, complementary cumulative distribution function is
$$
\bar{F}_{X}(x)=P(X>x)=1-F_{X}(x),
$$
where $F_{X}(x)$ is the cumulative distribution function.

### Priors

Weakly-informative priors for parameters are used. There are 7 covariates in the model, for each regressor $\beta$ can take positive and negative values, however, these values are not likely to be very large. For them, normal distribution $N(0,10)$ can be used.  Also, the prior has to be made for the shape parameter, $Gamma(1,1)$ is a variant, as the majority of the variance is not too close to zero, it has rather long tail. 

$$
\beta \sim N(0,10)
$$

$$
\alpha \sim \text{Gamma}(1,1)
$$
Chosen priors do not contribute strongly to the posterior, so the data can "speak for itself".

### Implemented in Stan

Data preparation
```{r, warning=FALSE, message=FALSE, comment=FALSE}
# read lung cancer data from "survival' library
data("cancer", package = "survival")

# omittimg NAs
data = cancer %>% na.omit()

# Censoring status is transformed to the column with 0-censored, 1-observed.
# The continuous variables are centered.
X=data
X$status[X$status==1] = 0
X$status[X$status==2] = 1
#X$male = ifelse(X$sex==1,1,0)
#X$female = ifelse(X$sex==2,1,0)
X$age=X$age-mean(X$age)
X$meal.cal=X$meal.cal-mean(X$meal.cal)
X$wt.loss=X$wt.loss-mean(X$wt.loss)

Xcens=X[X$status==0,]
Xcens = Xcens[-c(1,2,3)]
ycens=X$time[X$status==0]

Xobs=X[X$status==1,]
Xobs = as.matrix(Xobs[-c(1,2,3)])
yobs=X$time[X$status==1]
```

Building data list for Stan model
```{r, warning=FALSE, message=FALSE, comment=FALSE}
data_model = list(
  yobs = yobs,
  Xobs = Xobs,
  N = nrow(Xobs),
  M = ncol(Xobs),
  ycen = ycens,
  Xcen = Xcens,
  Ncen = nrow(Xcens)
)
```

Running model
```{r, warning=FALSE, message=FALSE, comment=FALSE}
# compile and run censored model
cwm = rstan::stan_model(file = "../stan/weibull_censored.stan")
# print out Stan code
print(cwm)
# learn the model with parameters 4 chains, 5000 iterations for each, 2500 iterations for warm-up
weibull_cens = rstan::sampling(cwm, data = data_model, iter = 5000)
```


## Hierarchical Weibull without censored data

Here we implement a model with some global shape parameter to be learned, but independent regressor parameters for each institution. Once more, we ignore the censored data. By virtue of this, we need not worry about complex distribution functions, but do sacrifice the number of data points we can learn from for each institution. We now consider our model in terms of the same $N$ data points and $M$ regressors, but we will estimate our covariate's weight according to the institution, of which we have $J$ in total. Thus our model is defined as
\begin{align*}
y_{ij} &\sim \text{Weibull}(\sigma_j, \alpha)\,,\quad i = 1,\dots,N,\,j= 1,\dots,J\\
\alpha &\sim \text{Half-Cauchy}(5),\\
\sigma &\propto \boldsymbol X \beta,\\
\beta_{kj} \sim& N(0, 1)\,,\quad k=1,\dots,M,\,j= 1,\dots,J.\\
\end{align*}
This is seen visually below in Figure \ref{}.

### Defining the link function

### Priors

The same priors are used for the hierarchical model as the pooled model

### Implemented in BRMS

```{r hier_weibull, warning=FALSE, message=FALSE, comment=FALSE}
# build model formula of the form
hw_formula <- formula(paste("time ~ (",
                            paste0(cov_labels, collapse = " + "),
                            "| inst)"))
hw_formula
# define strong priors over regressors and shape
hw_prior <- c(
  set_prior("normal(0, 1)", class = "sd"),
  set_prior("cauchy(0, 5)", class = "shape")
)
# generate model stan code
make_stancode(hw_formula,
              uncensored_data,
              weibull(link = "log", link_shape = "log"),
              hw_prior)
# fit hierarchical GLM model with BRMS, expliciting the Weibull family
weibull_hier <- brm(
  formula = hw_formula,
  data = uncensored_data,
  prior = hw_prior,
  family = weibull(link = "log", link_shape = "log"),
  iter = 10000,
  cores = parallel::detectCores(),
  control = list(adapt_delta = 0.9) # combat divergent transitions
)
```
