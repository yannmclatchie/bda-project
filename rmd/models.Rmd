# Description of models

In the following section, we will motivate and define mathematically four Generalised Linear Models (GLMs) implemented in Stan and using BRMS in two cases.

```{r}
# install libraries
library(survival)
library(tidyverse)
library(rstan)
library(brms)
library(bayesplot)
library(loo)
library(reshape2)
library(ggplot2)
library(splines2)
# set number of cores
options(mc.cores = parallel::detectCores())

# read lung cancer data from `survival` library
data("cancer", package = "survival")
# build dataset from only those non-censored data points
uncensored_data <- cancer %>%
  filter(status == 2) %>%
  drop_na()
# identify covariate labels and build design matrix
cov_labels <- uncensored_data %>%
  dplyr::select(-status,-time,-inst) %>%
  colnames()
# build design matrix
X <- as.matrix(uncensored_data[cov_labels])
# print(dim(X))
# [1] 120   7
y <- uncensored_data$time
# build data list for Stan model
weibull_data = list(
  y = y, X = X, N = length(y), M = ncol(X)
)
```

## Weibull without censored data

Let $y \sim \text{Weibull}(\alpha, \sigma)$, so that
$$
\text{Weibull}(y|\alpha,\sigma) =
\frac{\alpha}{\sigma} \, \left( \frac{y}{\sigma} \right)^{\alpha - 1}
\, \exp \! \left( \! - \left( \frac{y}{\sigma} \right)^{\alpha}
\right),
$$
for $y \in [0,\infty), \alpha \in \mathbb{R}^+,$ and $\sigma \in \mathbb{R}^+$. 

### Motivating the distribution

The Weibull distribution is often used as a more flexible and complex alternative to the semi-parametric proportional hazard Cox model for modelling time to failure events, since the hazard rate is not taken to be constant with time.

### The Weibull distribution as a member of the exponential family

Now take $\alpha$ fixed and finite, then it can be shown that this distribution belongs to the exponential family since we can write it's probability density function
$$
\text{Weibull}(y|\sigma) ={\alpha y^{\alpha -1}}\exp(-y^{\alpha}\sigma^{-\alpha}-\alpha\log\sigma),
$$
with
\begin{align*}
b(y)&={\alpha y^{\alpha -1}} \\
\eta&=\sigma^{-\alpha}\\
T(y)&=-y^{\alpha} \\
a(\eta)&=\alpha\log\sigma.
\end{align*}

### Defining the link function

Looking at our sufficient statistic $\eta=\sigma^{-\alpha}$, it can be shown that
$$
\sigma=\exp{({\frac{\log\eta}{-\alpha}})}
$$
where we construct $\eta = \exp(\boldsymbol X\beta)$ so that $\eta$ is strictly positive. Thus we choose a log link function for our GLM such that
$$
\sigma = \exp(-\frac{\boldsymbol X\beta}{\alpha}).
$$

### Priors

In our Stan model, we will enforce two priors over each of the regressors in the linear model, and the shape parameter of our resulting Weibull distribution. Mathematically, where we have $N$ data points and $M$ covariates, the model is defined as
\begin{align*}
y_i &\sim \text{Weibull}(\sigma, \alpha)\,,\quad i = 1,\dots,N,\\
\alpha &\sim \text{Half-Cauchy}(5),\\
\sigma &= \exp\left ( -\frac{\boldsymbol X \beta}{\alpha}\right ),\\
\beta_k \sim& N(0, 10)\,,\quad k=1,\dots,M.\\
\end{align*}
The choice of a Half-Cauchy prior is motivated in @taumain, so that inferences are sensitive to the choice of weakly-informative priors. Note that this is a specific case of the of the conditionally-conjugate folded-noncentral-t family of prior distributions. In this pooled model, we model these parameters the same across all institutions. Intuitively, this means that we expect the hazard to be equivalent regardless of which institution a patient is in.

### Implemented in Stan

Below, we fit the model in Stan and output the Stan code for the reader.

```{r weibull, warning=FALSE, message=FALSE, comment=FALSE}
# compile and run seperate model
wm <- rstan::stan_model(file = "../stan/weibull_survival.stan")
# print out Stan code
print(wm)
# learn the model parameters
weibull_model <- rstan::sampling(
  wm,
  iter = 10000,
  data = weibull_data
)
```

## Weibull with censored data

### Implemented in Stan

## Hierarchical Weibull without censored data

Here we implement a model with some global shape parameter to be learned, but independent regressor parameters for each institution. Once more, we ignore the censored data. By virtue of this, we need not worry about complex distribution functions, but do sacrifice the number of data points we can learn from for each institution. We now consider our model in terms of the same $N$ data points and $M$ regressors, but we will estimate our covariate's weight according to the institution, of which we have $J$ in total. Thus our model is defined as
\begin{align*}
y_{ij} &\sim \text{Weibull}(\sigma_j, \alpha)\,,\quad i = 1,\dots,N,\,j= 1,\dots,J\\
\alpha &\sim \text{Half-Cauchy}(5),\\
\sigma &\propto \boldsymbol X \beta,\\
\beta_{kj} \sim& N(0, 1)\,,\quad k=1,\dots,M,\,j= 1,\dots,J.\\
\end{align*}

### Defining the link function

### Priors

The same priors are used for the hierarchical model as the pooled model

### Implemented in BRMS

```{r hier_weibull, warning=FALSE, message=FALSE, comment=FALSE}
# build model formula of the form
hw_formula <- formula(paste("time ~ (",
                            paste0(cov_labels, collapse = " + "),
                            "| inst)"))
# define priors over regressors and shape
hw_prior <- c(
  set_prior("normal(0, 1)", class = "sd"),
  set_prior("cauchy(0, 5)", class = "shape")
)
# generate model stan code
make_stancode(hw_formula,
              uncensored_data,
              weibull(link = "log", link_shape = "log"),
              hw_prior)
# fit hierarchical GLM model with BRMS, expliciting a non-exponential family
weibull_hier <- brm(
  formula = hw_formula,
  data = uncensored_data,
  prior = hw_prior,
  family = weibull(link = "log", link_shape = "log"),
  iter = 10000,
  cores = parallel::detectCores()
)
```
